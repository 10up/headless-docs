"use strict";(self.webpackChunkheadless_doc=self.webpackChunkheadless_doc||[]).push([[2781],{3905:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>g});var n=r(7294);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function a(e,t){if(null==e)return{};var r,n,s=function(e,t){if(null==e)return{};var r,n,s={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(s[r]=e[r]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var p=n.createContext({}),l=function(e){var t=n.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},d=function(e){var t=l(e.components);return n.createElement(p.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var r=e.components,s=e.mdxType,i=e.originalType,p=e.parentName,d=a(e,["components","mdxType","originalType","parentName"]),u=l(r),c=s,g=u["".concat(p,".").concat(c)]||u[c]||h[c]||i;return r?n.createElement(g,o(o({ref:t},d),{},{components:r})):n.createElement(g,o({ref:t},d))}));function g(e,t){var r=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var i=r.length,o=new Array(i);o[0]=c;var a={};for(var p in t)hasOwnProperty.call(t,p)&&(a[p]=t[p]);a.originalType=e,a[u]="string"==typeof e?e:s,o[1]=a;for(var l=2;l<i;l++)o[l]=r[l];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}c.displayName="MDXCreateElement"},5386:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var n=r(7462),s=(r(7294),r(3905));const i={sidebar_position:0,slug:"/wordpress-integration/previews"},o="Previews",a={unversionedId:"WordPress Integration/previews",id:"WordPress Integration/previews",title:"Previews",description:"The preview feature requires the 10up's headless WordPress plugin installed. The preview functionality is built on top of Next.js preview API. It uses a short-lived JWT token generated on the WordPress side that can only be used for previewing, this means it is not neecessary to set up a hardcoded secret between WP and Next.js.",source:"@site/documentation/06-WordPress Integration/previews.md",sourceDirName:"06-WordPress Integration",slug:"/wordpress-integration/previews",permalink:"/docs/wordpress-integration/previews",draft:!1,editUrl:"https://github.com/10up/headless/tree/trunk/site/documentation/06-WordPress Integration/previews.md",tags:[],version:"current",lastUpdatedBy:"dependabot[bot]",lastUpdatedAt:1672859296,formattedLastUpdatedAt:"Jan 4, 2023",sidebarPosition:0,frontMatter:{sidebar_position:0,slug:"/wordpress-integration/previews"},sidebar:"tutorialSidebar",previous:{title:"Rendering Blocks in React Native",permalink:"/docs/gutenberg/rendering-blocks-io-ract-native"},next:{title:"Multisite",permalink:"/docs/wordpress-integration/multisite"}},p={},l=[{value:"Usage",id:"usage",level:2},{value:"FAQ",id:"faq",level:2},{value:"Make sure you defined the right <code>single</code> property when registering the custom post type. See headless config docs. The <code>single</code> property must match the route prefix for the custom post type.",id:"make-sure-you-defined-the-right-single-property-when-registering-the-custom-post-type-see-headless-config-docs-the-single-property-must-match-the-route-prefix-for-the-custom-post-type",level:2},{value:"slug: /wordpress-integration/previews",id:"slug-wordpress-integrationpreviews",level:2},{value:"Usage",id:"usage-1",level:2},{value:"FAQ",id:"faq-1",level:2}],d={toc:l};function u(e){let{components:t,...r}=e;return(0,s.kt)("wrapper",(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"previews"},"Previews"),(0,s.kt)("p",null,"The preview feature requires the 10up's headless WordPress plugin installed. The preview functionality is built on top of ",(0,s.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/advanced-features/preview-mode"},"Next.js preview API"),". It uses a short-lived JWT token generated on the WordPress side that can only be used for previewing, this means it is not neecessary to set up a hardcoded secret between WP and Next.js."),(0,s.kt)("p",null,"In order for previews to work, make sure the frontend URL is entered in WP settings as per instructions in ",(0,s.kt)("a",{parentName:"p",href:"/docs/getting-started/installing-wordpress-plugin"},"Installing WordPress Plugin"),"."),(0,s.kt)("p",null,"The logic for generated the JWT token and redirecting to the preview endpoint can be seen ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/10up/headless/blob/develop/wp/tenup-headless-wp/includes/classes/Preview/preview.php"},"here"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"$token = PreviewToken::generate(\n    [\n        'type'      => 'preview',\n        'post_type' => $post_type,\n        'post_id'   => $post_id,\n    ]\n);\n\n$preview_url = sprintf(\n    '%sapi/preview?post_id=%d&post_type=%s&is_revision=%s&token=%s',\n    trailingslashit( Plugin::get_react_url() ),\n    $post_id,\n    $post_type,\n    $is_revision ? '1' : '0',\n    $token\n);\n\nwp_redirect( $preview_url );\ndie();\n")),(0,s.kt)("p",null,"Below is a summary of the preview workflow."),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"First a token of type ",(0,s.kt)("inlineCode",{parentName:"li"},"preview")," is generated"),(0,s.kt)("li",{parentName:"ul"},"The token encodes the post type and post id."),(0,s.kt)("li",{parentName:"ul"},"A preview URL is generated assuming the preview endpoint lives at ",(0,s.kt)("inlineCode",{parentName:"li"},"/api/preview")),(0,s.kt)("li",{parentName:"ul"},"WordPress redirects to the preview endpoint"),(0,s.kt)("li",{parentName:"ul"},"The token is sent alongside the post_type, post_id and a a boolean indicating whether the post being previewed is a revision or not. "),(0,s.kt)("li",{parentName:"ul"},"The token is verify against the parameters and the token is used to fetch the post's draft/revision content.")),(0,s.kt)("h2",{id:"usage"},"Usage"),(0,s.kt)("p",null,"The Next.js project ",(0,s.kt)("strong",{parentName:"p"},"must")," expose a ",(0,s.kt)("inlineCode",{parentName:"p"},"api/preview")," endpoint that uses the ",(0,s.kt)("a",{parentName:"p",href:"/api/modules/10up_headless_next/#previewhandler"},"previewHandler"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"//src/pages/api/preview.js\nimport { previewHandler } from '@10up/headless-next';\n\n/**\n * The Preview endpoint just needs to proxy the default preview handler\n *\n * @param {*} req Next.js request object\n * @param {*} res  Next.js response object\n *\n * @returns\n */\nexport default async function handler(req, res) {\n    return previewHandler(req, res);\n}\n")),(0,s.kt)("p",null,"That's all that is needed in order to enable WordPress preview."),(0,s.kt)("p",null,"While previewing the URL will not reflect the actual URL of the post, but instead it will contain the post id and a ",(0,s.kt)("inlineCode",{parentName:"p"},"-preview")," suffix."),(0,s.kt)("h2",{id:"faq"},"FAQ"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"After a while the preview URL stops working")),(0,s.kt)("p",null,"The JWT token expires after 5 min by default, after this period, open another preview window from WordPress to preview the post."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"I'm unable to preview a custom post type")),(0,s.kt)("h2",{id:"make-sure-you-defined-the-right-single-property-when-registering-the-custom-post-type-see-headless-config-docs-the-single-property-must-match-the-route-prefix-for-the-custom-post-type"},"Make sure you defined the right ",(0,s.kt)("inlineCode",{parentName:"h2"},"single")," property when registering the custom post type. See ",(0,s.kt)("a",{parentName:"h2",href:"/docs/getting-started/headless-config/#customposttypes"},"headless config docs"),". The ",(0,s.kt)("inlineCode",{parentName:"h2"},"single")," property must match the route prefix for the custom post type."),(0,s.kt)("p",null,"sidebar_position: 0"),(0,s.kt)("h2",{id:"slug-wordpress-integrationpreviews"},"slug: /wordpress-integration/previews"),(0,s.kt)("h1",{id:"previews-1"},"Previews"),(0,s.kt)("p",null,"The preview feature requires the 10up's headless WordPress plugin installed. The preview functionality is built on top of ",(0,s.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/advanced-features/preview-mode"},"Next.js preview API"),". It uses a short-lived JWT token generated on the WordPress side that can only be used for previewing, this means it is not neecessary to set up a hardcoded secret between WP and Next.js."),(0,s.kt)("p",null,"In order for previews to work, make sure the frontend URL is entered in WP settings as per instructions in ",(0,s.kt)("a",{parentName:"p",href:"/docs/getting-started/installing-wordpress-plugin"},"Installing WordPress Plugin"),"."),(0,s.kt)("p",null,"The logic for generated the JWT token and redirecting to the preview endpoint can be seen ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/10up/headless/blob/develop/wp/tenup-headless-wp/includes/classes/Preview/preview.php"},"here"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"$token = PreviewToken::generate(\n    [\n        'type'      => 'preview',\n        'post_type' => $post_type,\n        'post_id'   => $post_id,\n    ]\n);\n\n$preview_url = sprintf(\n    '%sapi/preview?post_id=%d&post_type=%s&is_revision=%s&token=%s',\n    trailingslashit( Plugin::get_react_url() ),\n    $post_id,\n    $post_type,\n    $is_revision ? '1' : '0',\n    $token\n);\n\nwp_redirect( $preview_url );\ndie();\n")),(0,s.kt)("p",null,"Below is a summary of the preview workflow."),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"First a token of type ",(0,s.kt)("inlineCode",{parentName:"li"},"preview")," is generated"),(0,s.kt)("li",{parentName:"ul"},"The token encodes the post type and post id."),(0,s.kt)("li",{parentName:"ul"},"A preview URL is generated assuming the preview endpoint lives at ",(0,s.kt)("inlineCode",{parentName:"li"},"/api/preview")),(0,s.kt)("li",{parentName:"ul"},"WordPress redirects to the preview endpoint"),(0,s.kt)("li",{parentName:"ul"},"The token is sent alongside the post_type, post_id and a a boolean indicating whether the post being previewed is a revision or not. "),(0,s.kt)("li",{parentName:"ul"},"The token is verify against the parameters and the token is used to fetch the post's draft/revision content.")),(0,s.kt)("h2",{id:"usage-1"},"Usage"),(0,s.kt)("p",null,"The Next.js project ",(0,s.kt)("strong",{parentName:"p"},"must")," expose a ",(0,s.kt)("inlineCode",{parentName:"p"},"api/preview")," endpoint that uses the ",(0,s.kt)("a",{parentName:"p",href:"/api/modules/10up_headless_next/#previewhandler"},"previewHandler"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"//src/pages/api/preview.js\nimport { previewHandler } from '@10up/headless-next';\n\n/**\n * The Preview endpoint just needs to proxy the default preview handler\n *\n * @param {*} req Next.js request object\n * @param {*} res  Next.js response object\n *\n * @returns\n */\nexport default async function handler(req, res) {\n    return previewHandler(req, res);\n}\n")),(0,s.kt)("p",null,"That's all that is needed in order to enable WordPress preview."),(0,s.kt)("p",null,"While previewing the URL will not reflect the actual URL of the post, but instead it will contain the post id and a ",(0,s.kt)("inlineCode",{parentName:"p"},"-preview")," suffix."),(0,s.kt)("h2",{id:"faq-1"},"FAQ"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"After a while the preview URL stops working")),(0,s.kt)("p",null,"The JWT token expires after 5 min by default, after this period, open another preview window from WordPress to preview the post."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"I'm unable to preview a custom post type")),(0,s.kt)("p",null,"Make sure you defined the right ",(0,s.kt)("inlineCode",{parentName:"p"},"single")," property when registering the custom post type. See ",(0,s.kt)("a",{parentName:"p",href:"/docs/getting-started/headless-config/#customposttypes"},"headless config docs"),". The ",(0,s.kt)("inlineCode",{parentName:"p"},"single")," property must match the route prefix for the custom post type."))}u.isMDXComponent=!0}}]);